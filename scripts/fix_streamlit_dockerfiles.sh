#!/usr/bin/env bash
set -euo pipefail

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 1) Patch the three Streamlit Dockerfiles (no -E, so it works with older sed)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
FILES=(Dockerfile.streamlit Dockerfile.live_trades Dockerfile.diagnostics)

for df in "${FILES[@]}"; do
  if [ -f "$df" ]; then
    echo "๐ง Patching $dfโฆ"
    sed -i '/^RUN pip install/ a\
    altair==4.2.2 \\ 
    vega_datasets \\ 
' "$df"
  else
    echo "โ๏ธ  $df not found, skipping"
  fi
done

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 2) Tear down & prune
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo
echo "โฌ๏ธ  docker compose down (remove orphans & volumes)"
docker compose down --remove-orphans --volumes

echo
echo "๐งน docker builder prune --all --force"
docker builder prune --all --force

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3) Rebuild & bring up
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo
echo "๐จ docker compose build --no-cache"
docker compose build --no-cache

echo
echo "๐ docker compose up -d"
docker compose up -d

echo
echo "โ Done! Your UIs should now include Altair & vega_datasets."
echo "   Tail logs if you like:"
echo "     docker compose logs -f diagnostics-ui"
echo "     docker compose logs -f live-trades-ui"
